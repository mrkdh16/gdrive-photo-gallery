<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhee Family Photo Gallery</title>
    <!-- HEIC conversion library -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            min-height: 100vh;
            padding: 40px 20px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #222;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 3rem;
            letter-spacing: -1px;
            animation: fadeInDown 1s ease-out;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 4rem;
            animation: fadeInUp 1s ease-out 0.2s both;
        }

        .upload-btn {
            background: #333;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 400;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 8px;
            letter-spacing: 0.5px;
        }

        .upload-btn:hover {
            background: #555;
            transform: translateY(-1px);
        }

        .upload-btn:active {
            transform: translateY(0);
        }

        #file-input {
            display: none;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            margin-top: 2rem;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            background: white;
            animation: slideInUp 0.6s ease-out;
        }

        .photo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .photo-item img {
            width: 100%;
            height: 280px;
            object-fit: cover;
            transition: transform 0.3s ease;
            background: #f0f0f0; /* Show background if image fails to load */
        }

        .photo-item img.loading {
            background: #f0f0f0 url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ccc"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>') center/50px no-repeat;
        }

        .photo-item img.error {
            background: #ffebee url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f44336"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/></svg>') center/50px no-repeat;
        }

        .photo-item:hover img {
            transform: scale(1.02);
        }

        .photo-info {
            padding: 20px;
            background: white;
        }

        .photo-title {
            font-size: 1rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .photo-size {
            color: #888;
            font-size: 0.85rem;
            font-weight: 400;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 60px;
        }

        .modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.15);
        }

        .close {
            position: absolute;
            top: 30px;
            right: 40px;
            color: #333;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover {
            color: #666;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.1);
            color: #333;
            border: none;
            font-size: 24px;
            font-weight: 300;
            padding: 16px 20px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background: rgba(0,0,0,0.2);
        }

        .prev-btn {
            left: 30px;
        }

        .next-btn {
            right: 30px;
        }

        .filters {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 3rem;
            flex-wrap: wrap;
            animation: fadeInUp 1s ease-out 0.4s both;
        }

        .filter-btn {
            background: transparent;
            color: #666;
            border: 1px solid #ddd;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 400;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        .stats {
            text-align: center;
            color: #666;
            margin-bottom: 3rem;
            font-size: 0.95rem;
            font-weight: 400;
            animation: fadeInUp 1s ease-out 0.6s both;
        }

        .empty-gallery {
            text-align: center;
            color: #999;
            font-size: 1.1rem;
            font-weight: 300;
            margin-top: 4rem;
        }

        #download-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            text-decoration: none;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        #download-btn:hover {
            background: #333;
            color: white;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                gap: 20px;
            }
            
            .upload-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
                margin: 5px;
            }
            
            .nav-btn {
                font-size: 20px;
                padding: 12px 16px;
            }

            .modal-content {
                padding: 40px 20px;
            }
        }

        @media (max-width: 480px) {
            .gallery {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .filters {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .upload-section {
                margin-bottom: 3rem;
            }

            h1 {
                font-size: 1.8rem;
                margin-bottom: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rhee Family Photo Gallery</h1>
        
        <div class="upload-section">
            <input type="file" id="file-input" multiple accept="image/*,.heic,.HEIC">
            <button class="upload-btn" onclick="refreshGallery()">
                Refresh Gallery
            </button>
        </div>

        <div class="stats">
            <span id="photo-count">0 photos in gallery</span>
        </div>

        <div class="gallery" id="gallery">
            <div class="empty-gallery">
                <p>No photos yet. Upload some to get started.</p>
            </div>
        </div>
    </div>

    <!-- Modal for full-size image viewing -->
    <div id="modal" class="modal">
        <span class="close">&times;</span>
        <a id="download-btn" class="upload-btn" href="#" target="_blank" download>Download</a>
        <button class="nav-btn prev-btn">❮</button>
        <button class="nav-btn next-btn">❯</button>
        <div class="modal-content">
            <img id="modal-img" src="" alt="">
        </div>
    </div>

    <script>
        let photos = JSON.parse(localStorage.getItem('galleryPhotos')) || [];
        let currentImageIndex = 0;
        let filteredPhotos = [];
        
        // Default Google Drive folder ID - replace this with your actual folder ID
        let googleDriveFolderId = '162O-7jtXbiX74_4ZrUIxjEZrXlhOtSXR'; // Just the ID, not the full URL
        
        // Loading state
        let isLoading = false;

        // Initialize gallery
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-load Google Drive photos on page load
            autoLoadGoogleDrivePhotos();
        });

                // New event listener for the entire gallery
        document.getElementById('gallery').addEventListener('click', function(e) {
            // Check if the clicked item is an image inside a photo-item
            if (e.target.tagName === 'IMG' && e.target.closest('.photo-item')) {
                // Get the index from the parent's data-index attribute
                const photoItem = e.target.closest('.photo-item');
                const index = parseInt(photoItem.dataset.index, 10);
                
                // Open the modal if the index is a valid number
                if (!isNaN(index)) {
                    openModal(index);
                }
            }
        });

        // File input handler with HEIC support
        document.getElementById('file-input').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(async file => {
                if (file.type.startsWith('image/') || file.name.toLowerCase().endsWith('.heic')) {
                    await processImageFile(file);
                }
            });
            e.target.value = ''; // Clear the input
        });

        // Process image files including HEIC conversion
        async function processImageFile(file) {
            try {
                let processedFile = file;
                let fileName = file.name;
                
                // Check if it's a HEIC file and convert it
                if (file.name.toLowerCase().endsWith('.heic') || file.type === 'image/heic') {
                    console.log('Converting HEIC file:', file.name);
                    
                    // Show loading indicator for this specific file
                    showFileProcessingStatus(`Converting ${file.name}...`);
                    
                    try {
                        // Convert HEIC to JPEG
                        const convertedBlob = await heic2any({
                            blob: file,
                            toType: "image/jpeg",
                            quality: 0.9
                        });
                        
                        // Create a new file object from the converted blob
                        processedFile = new File([convertedBlob], fileName.replace(/\.heic$/i, '.jpg'), {
                            type: 'image/jpeg'
                        });
                        fileName = fileName.replace(/\.heic$/i, '.jpg');
                        
                        hideFileProcessingStatus();
                        
                    } catch (conversionError) {
                        console.error('Error converting HEIC file:', conversionError);
                        alert(`Failed to convert ${file.name}. Please try a different file.`);
                        hideFileProcessingStatus();
                        return;
                    }
                }
                
                // Process the file (original or converted)
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const photo = {
                            id: Date.now() + Math.random(),
                            src: e.target.result,
                            name: fileName,
                            size: formatFileSize(processedFile.size),
                            width: img.width,
                            height: img.height,
                            orientation: getOrientation(img.width, img.height),
                            uploadDate: new Date().toLocaleDateString(),
                            originalFormat: file.name.toLowerCase().endsWith('.heic') ? 'HEIC (converted)' : undefined
                        };
                        photos.push(photo);
                        saveToLocalStorage();
                        displayPhotos();
                        updateStats();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(processedFile);
                
            } catch (error) {
                console.error('Error processing file:', error);
                alert(`Error processing ${file.name}: ${error.message}`);
            }
        }

        // Show/hide file processing status
        function showFileProcessingStatus(message) {
            let statusDiv = document.getElementById('file-processing-status');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'file-processing-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #333;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    font-size: 0.9rem;
                    z-index: 1001;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                document.body.appendChild(statusDiv);
            }
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function hideFileProcessingStatus() {
            const statusDiv = document.getElementById('file-processing-status');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        function getOrientation(width, height) {
            if (width > height) return 'landscape';
            if (height > width) return 'portrait';
            return 'square';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function displayPhotos(filter = 'all') {
            const gallery = document.getElementById('gallery');
            
            if (isLoading) {
                gallery.innerHTML = '<div class="empty-gallery"><p>Loading photos from Google Drive...</p></div>';
                return;
            }
            
            filteredPhotos = filter === 'all' ? photos : photos.filter(photo => photo.orientation === filter);
            
            if (filteredPhotos.length === 0) {
                gallery.innerHTML = '<div class="empty-gallery"><p>No photos available. Photos will auto-load from Google Drive.</p></div>';
                return;
            }

            gallery.innerHTML = filteredPhotos.map((photo, index) => `
                <div class="photo-item" data-index="${index}">
                    <img src="${photo.src}" 
                         alt="${photo.name}" 
                         onerror="handleImageError(this, '${photo.driveFileId || ''}')"
                         onload="handleImageLoad(this)">
                    <div class="photo-info">
                        <div class="photo-title">${photo.name}</div>
                        <div class="photo-size">${photo.size} • ${photo.width}x${photo.height}${photo.source ? ' • ' + photo.source : ''}${photo.originalFormat ? ' • ' + photo.originalFormat : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function clearGallery() {
            if (confirm('Are you sure you want to clear the entire gallery?')) {
                photos = [];
                saveToLocalStorage();
                displayPhotos();
                updateStats();
            }
        }

        function updateStats() {
            const count = photos.length;
            document.getElementById('photo-count').textContent = 
                count === 0 ? '0 photos in gallery' : 
                count === 1 ? '1 photo in gallery' : 
                `${count} photos in gallery`;
        }

        function saveToLocalStorage() {
            localStorage.setItem('galleryPhotos', JSON.stringify(photos));
        }

        // Auto-load Google Drive photos on page load
        async function autoLoadGoogleDrivePhotos() {
            // Check if we already have Drive photos loaded recently
            const lastLoadTime = localStorage.getItem('lastDriveLoadTime');
            const now = Date.now();
            const oneHour = 60 * 60 * 1000; // 1 hour in milliseconds
            
            // Only auto-load if we haven't loaded in the last hour (to avoid excessive API calls)
            if (lastLoadTime && (now - parseInt(lastLoadTime)) < oneHour) {
                displayPhotos();
                updateStats();
                return;
            }
            
            // Set loading state
            isLoading = true;
            displayPhotos();
            updateStats();
            
            try {
                // Always try the real API first since the test worked
                console.log('Attempting to load from Google Drive with folder ID:', googleDriveFolderId);
                await loadGoogleDrivePhotosReal();
                
                // Mark as loaded
                localStorage.setItem('lastDriveLoadTime', now.toString());
                
            } catch (error) {
                console.error('Error auto-loading from Google Drive:', error);
                // Fall back to demo photos if real API fails
                console.log('Falling back to demo photos due to error:', error.message);
                await simulateGoogleDriveLoad();
                // Still mark as loaded to avoid repeated attempts
                localStorage.setItem('lastDriveLoadTime', now.toString());
            } finally {
                isLoading = false;
                displayPhotos();
                updateStats();
            }
        }

        // Refresh gallery - reload from Google Drive
        async function refreshGallery() {
            // Clear existing photos and force reload
            photos = [];
            localStorage.removeItem('lastDriveLoadTime');
            saveToLocalStorage();
            await autoLoadGoogleDrivePhotos();
        }

        // Google Drive Integration - remove old functions and update
        async function loadGoogleDrivePhotosReal() {
            console.log('loadGoogleDrivePhotosReal called with folder ID:', googleDriveFolderId);

            // This now calls YOUR secure Netlify function
            const apiUrl = `/.netlify/functions/get-drive-photos?folderId=${googleDriveFolderId}`;

            console.log('Making request to Netlify function:', apiUrl);

            const response = await fetch(apiUrl);
            const data = await response.json();

            console.log('API response from Netlify function:', data);

            if (data.error || !response.ok) {
                console.error('API Error:', data.error || data);
                throw new Error(data.error?.message || 'Failed to fetch from Netlify function.');
            }

            if (!data.files || data.files.length === 0) {
                console.log('No files found in the folder');
                return;
            }

            // (The rest of the function remains the same)
            photos = photos.filter(photo => photo.source !== 'Google Drive');

            const drivePhotos = data.files.map(file => {
                const width = file.imageMediaMetadata?.width || 400;
                const height = file.imageMediaMetadata?.height || 300;
                const imageUrl = `https://drive.google.com/thumbnail?id=${file.id}&sz=w1600`;

                return {
                    id: 'drive_' + file.id,
                    src: imageUrl,
                    downloadUrl: file.webContentLink,
                    name: file.name,
                    size: formatFileSize(parseInt(file.size) || 0),
                    width: width,
                    height: height,
                    orientation: getOrientation(width, height),
                    uploadDate: new Date().toLocaleDateString(),
                    source: 'Google Drive',
                    driveFileId: file.id
                };
            });

            console.log('Processed drive photos:', drivePhotos);
            photos.push(...drivePhotos);
            saveToLocalStorage();
            console.log('Total photos after adding drive photos:', photos.length);
        }

// Modal functionality
        function openModal(index) {
            const photoToDisplay = filteredPhotos[index];
            
            // If there's no valid photo, do nothing.
            if (!photoToDisplay) {
                console.error('Could not find photo for index:', index);
                return;
            }

            currentImageIndex = index;
            const modal = document.getElementById('modal');
            const modalImg = document.getElementById('modal-img');
            const downloadBtn = document.getElementById('download-btn');

            // Set the image source for the modal view
            modalImg.src = photoToDisplay.src;
            
            // Update the download button's link and visibility
            if (photoToDisplay.downloadUrl) {
                downloadBtn.href = photoToDisplay.downloadUrl;
                downloadBtn.style.display = 'block';
            } else {
                // Hide the button if there is no download link
                downloadBtn.style.display = 'none';
            }
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function showPrevImage() {
            currentImageIndex = currentImageIndex > 0 ? currentImageIndex - 1 : filteredPhotos.length - 1;
            document.getElementById('modal-img').src = filteredPhotos[currentImageIndex].src;
        }

        function showNextImage() {
            currentImageIndex = currentImageIndex < filteredPhotos.length - 1 ? currentImageIndex + 1 : 0;
            document.getElementById('modal-img').src = filteredPhotos[currentImageIndex].src;
        }

        // Event listeners for modal
        document.querySelector('.close').addEventListener('click', closeModal);
        document.querySelector('.prev-btn').addEventListener('click', showPrevImage);
        document.querySelector('.next-btn').addEventListener('click', showNextImage);

        // Close modal when clicking outside the image
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modal').style.display === 'block') {
                switch(e.key) {
                    case 'Escape':
                        closeModal();
                        break;
                    case 'ArrowLeft':
                        showPrevImage();
                        break;
                    case 'ArrowRight':
                        showNextImage();
                        break;
                }
            }
        });

        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelector('.filter-btn.active').classList.remove('active');
                this.classList.add('active');
                displayPhotos(this.dataset.filter);
            });
        });

        // Add touch support for mobile
        let touchStartX = 0;
        let touchEndX = 0;

        document.getElementById('modal').addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.getElementById('modal').addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleGesture();
        });

        function handleGesture() {
            if (touchEndX < touchStartX - 50) {
                showNextImage();
            }
            if (touchEndX > touchStartX + 50) {
                showPrevImage();
            }
        }

        // Handle image loading and errors
        function handleImageLoad(img) {
            console.log('Image loaded successfully:', img.src);
            img.classList.remove('loading', 'error');
        }

        function handleImageError(img, driveFileId) {
            console.error('Image failed to load:', img.src);
            img.classList.add('error');
            
            // Try alternative URL formats
            if (driveFileId && img.src.includes('thumbnail')) {
                console.log('Trying alternative URL format...');
                img.src = `https://drive.google.com/uc?id=${driveFileId}&export=view`;
            } else if (driveFileId && img.src.includes('uc?id=')) {
                console.log('Trying direct access URL...');
                img.src = `https://lh3.googleusercontent.com/d/${driveFileId}`;
            } else {
                console.log('All URL formats failed for file:', driveFileId);
                // Show error state
                img.alt = 'Failed to load image';
            }
        }


    </script>
</body>
</html>